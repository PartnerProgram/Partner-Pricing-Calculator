<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Recast Pricing CPQ — Partner Estimator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .shadow-soft { box-shadow: 0 1px 2px rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.06); }
    .shadow-softer { box-shadow: 0 1px 2px rgba(0,0,0,.04), 0 14px 40px rgba(0,0,0,.08); }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900 antialiased">
  <div id="app"></div>

<script>
/* =======================
   STATE
======================= */
const STATE = {
  items: [
    { id: randomId(), productKey: 'rct', qtyText: '1000', addSupport: false, pricingModel: 'endpoint' }
  ],
  partnerNewMargin: 25,
  partnerRenMargin: 15,
  toast: null
};

/* =======================
   DATA (restored from your original)
======================= */
const TIERS_BASE5 = [
  { max: 1000, rate: 5.00 }, { max: 2000, rate: 4.50 }, { max: 3000, rate: 4.25 }, { max: 4000, rate: 4.00 }, { max: 5000, rate: 3.75 },
  { max: 6000, rate: 3.50 }, { max: 7000, rate: 3.25 }, { max: 8000, rate: 3.00 }, { max: 9000, rate: 2.75 }, { max: 10000, rate: 2.50 },
  { max: 15000, rate: 2.25 }, { max: 20000, rate: 2.00 }, { max: 25000, rate: 1.75 }, { max: 30000, rate: 1.50 }, { max: 40000, rate: 1.25 },
  { max: 50000, rate: 1.00 }, { max: 60000, rate: 0.75 }, { max: 70000, rate: 0.50 }, { max: 80000, rate: 0.40 }, { max: 90000, rate: 0.35 },
  { max: 100000, rate: 0.30 }, { max: 120000, rate: 0.25 }, { max: 140000, rate: 0.20 }, { max: 160000, rate: 0.15 }, { max: 180000, rate: 0.10 },
  { max: 200000, rate: 0.05 }, { max: Infinity, rate: 0.10 }
];

const USER_TIERS_MONTHLY = [
  { max: 999, rate: 4.00 },
  { max: 4999, rate: 3.50 },
  { max: 9999, rate: 3.00 },
  { max: 24999, rate: 2.50 },
  { max: 49999, rate: 2.00 },
  { max: Infinity, rate: 1.50 }
];

const PRODUCTS = {
  rct:      { name: 'Right Click Tools (Core)', baseFactor: 1,     platformFee: 7500,  minTotal: 12500 },
  patch:    { name: 'Patching',                 baseFactor: 1,     platformFee: 7500,  minTotal: 12500 },
  insights: { name: 'Insights',                 baseFactor: 1,     platformFee: 0,     minTotal: 5000  },
  priv:     { name: 'Privilege Manager',        baseFactor: 1,     platformFee: 0,     minTotal: 5000  },
  aw_cloud: { name: 'Application Workspace — Direct Cloud',  baseFactor: 11/5, platformFee: 15000, minTotal: 26000 },
  aw_onprem:{ name: 'Application Workspace — Direct On-Prem', baseFactor: 10/5, platformFee: 15000, minTotal: 25000 }
};

/* =======================
   UTILS
======================= */
function cx(...a){ return a.filter(Boolean).join(' '); }
function isAW(key){ return key === 'aw_cloud' || key === 'aw_onprem'; }
function digitsOnly(text){ return String(text ?? '').replace(/[^\d]/g,''); }
function int(n){
  n = Number(String(n).replace(/[^0-9\-]/g,''));
  return isFinite(n) ? Math.max(0, Math.floor(n)) : 0;
}
function clampFloor(r){ return Math.max(r, 0.10); }
function money(n){ return (!isFinite(n)) ? '—' : n.toLocaleString(undefined,{ style:'currency', currency:'USD' }); }
function randomId(){
  try { return crypto.randomUUID(); } catch { return 'id-' + Math.random().toString(36).slice(2); }
}
function setToast(type, message){
  STATE.toast = { type, message };
  render();
  clearTimeout(setToast._t);
  setToast._t = setTimeout(() => { STATE.toast = null; render(); }, 1800);
}

/* =======================
   PRICING HELPERS
======================= */
function tiersFor(productKey){
  const f = (PRODUCTS[productKey] || PRODUCTS.rct).baseFactor;
  return TIERS_BASE5.map(t => ({ max: t.max, rate: clampFloor(+(t.rate * f).toFixed(4)) }));
}

function graduatedSubtotal(units, tiers){
  let rem = Math.max(0, Math.floor(units));
  let from = 0, sum = 0;
  for(const b of tiers){
    if(rem <= 0) break;
    const chunk = Math.min(rem, b.max - from);
    sum += chunk * b.rate;
    rem -= chunk;
    from = b.max;
  }
  return sum;
}

function premiumSupportCost(add, basePlusPlat){
  return add ? Math.max(basePlusPlat * 0.20, 6000) : 0;
}

/* =======================
   MODEL
======================= */
function computeItem(item){
  const meta = PRODUCTS[item.productKey] || PRODUCTS.rct;

  const aw = isAW(item.productKey);
  const userMode = aw; // in this UX, AW is always per-user (matches your original implementation)

  let units = int(item.qtyText);

  let baseARR = 0;
  let platformFeeApplied = 0;
  let platformWaived = false;
  let basePlusPlatform = 0;
  let support = 0;

  if(userMode){
    units = Math.max(250, units);
    const monthly = graduatedSubtotal(units, USER_TIERS_MONTHLY);
    baseARR = monthly * 12;

    platformFeeApplied = 0;
    platformWaived = true;
    basePlusPlatform = baseARR;

    // Premium support disabled in per-user AW pricing model (as in your original code)
    support = 0;
  } else {
    const endpointTiers = tiersFor(item.productKey);
    baseARR = graduatedSubtotal(units, endpointTiers);

    platformFeeApplied = baseARR >= 30000 ? 0 : meta.platformFee;
    platformWaived = platformFeeApplied === 0;

    basePlusPlatform = Math.max(baseARR + platformFeeApplied, meta.minTotal);
    support = premiumSupportCost(!!item.addSupport, basePlusPlatform);
  }

  const msrp = basePlusPlatform + support;

  return {
    id: item.id,
    productKey: item.productKey,
    productName: meta.name,
    qty: units,
    qtyLabel: userMode ? 'Users' : 'Endpoints',
    userMode,
    addSupport: !!item.addSupport && !userMode,

    baseARR,
    platformFeeApplied,
    platformWaived,
    support,
    msrp,

    partnerNew: msrp * (1 - STATE.partnerNewMargin/100),
    partnerRen: msrp * (1 - STATE.partnerRenMargin/100),
  };
}

function model(){
  const items = STATE.items.map(computeItem);
  const totals = items.reduce((a,it)=>({
    msrp: a.msrp + it.msrp,
    new: a.new + it.partnerNew,
    ren: a.ren + it.partnerRen
  }), { msrp:0, new:0, ren:0 });
  return { items, totals };
}

/* =======================
   COPY QUOTE (professional paste-ready)
======================= */
function buildQuoteText(m){
  const stamp = new Date().toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit' });
  const tierLabel =
    (STATE.partnerNewMargin===25 && STATE.partnerRenMargin===15) ? 'Tier 1 (25% New / 15% Ren)' :
    (STATE.partnerNewMargin===15 && STATE.partnerRenMargin===15) ? 'Tier 2 (15% New / 15% Ren)' :
    (STATE.partnerNewMargin===5 && STATE.partnerRenMargin===5) ? 'Tier 3 (5% New / 5% Ren)' :
    `Custom (${STATE.partnerNewMargin}% New / ${STATE.partnerRenMargin}% Ren)`;

  const lines = [];
  lines.push(`RECAST PRICING ESTIMATE (Partner)`);
  lines.push(`Generated: ${stamp}`);
  lines.push(`Partner Tier: ${tierLabel}`);
  lines.push(``);
  lines.push(`LINE ITEMS`);
  lines.push(`Product | Qty | MSRP (ARR) | Partner (New) | Renewal | Notes`);
  lines.push(`---|---:|---:|---:|---:|---`);

  for(const it of m.items){
    const notes = it.userMode
      ? `Pricing: per user (min 250); Platform: waived; Premium Support: —`
      : `Pricing: per endpoint; Platform: ${it.platformWaived ? 'waived' : money(it.platformFeeApplied)}; Premium Support: ${it.addSupport ? 'included' : '—'}`;

    lines.push(
      `${it.productName} | ${it.qty.toLocaleString()} ${it.qtyLabel} | ${money(it.msrp)} | ${money(it.partnerNew)} | ${money(it.partnerRen)} | ${notes}`
    );
  }

  lines.push(``);
  lines.push(`TOTALS`);
  lines.push(`Metric | Amount`);
  lines.push(`---|---:`);
  lines.push(`Total ARR (MSRP) | ${money(m.totals.msrp)}`);
  lines.push(`Partner Total (Net New) | ${money(m.totals.new)}`);
  lines.push(`Partner Total (Renewal) | ${money(m.totals.ren)}`);
  lines.push(``);
  lines.push(`Notes: Estimate only. Not a formal quote. MSRP includes platform fee (if not waived) and premium support (if selected) per line item.`);
  return lines.join('\n');
}

async function copyToClipboard(text){
  try { await navigator.clipboard.writeText(text); return true; }
  catch {
    try {
      const ta=document.createElement('textarea');
      ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      return true;
    } catch { return false; }
  }
}

/* =======================
   RENDER
======================= */
function render(){
  const m = model();
  const root = document.getElementById('app');

  root.innerHTML = `
    ${header()}
    <main class="max-w-7xl mx-auto px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">

      <section class="lg:col-span-8 space-y-6">

        <!-- Partner Tier ABOVE line items (as requested) -->
        <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-soft">
          <h3 class="font-semibold">Partner Tier</h3>
          <p class="text-sm text-slate-600 mt-1">Select Margin Tier (Based on Deal Registration Guidlines = Tier 1 / Tier 2 / Tier 3).</p>
          <div class="mt-4 flex flex-wrap gap-2">
            ${tierBtn('25% Tier 1',25,15)}
            ${tierBtn('15% Tier 2',15,15)}
            ${tierBtn('5% Tier 3',5,5)}
          </div>
        </div>

        <!-- Line Items -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-soft overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-200 font-semibold flex items-center justify-between">
            <span>Line Items</span>
            <button data-action="add-item" class="text-sm font-semibold text-blue-600 hover:text-blue-700">+ Add Product</button>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-700">
                <tr>
                  <th class="px-5 py-3 text-left font-semibold">Product</th>
                  <th class="px-5 py-3 text-left font-semibold">Qty</th>
                  <th class="px-5 py-3 text-left font-semibold">Support</th>
                  <th class="px-5 py-3 text-left font-semibold">MSRP</th>
                  <th class="px-5 py-3 text-left font-semibold">Partner $</th>
                  <th class="px-5 py-3 text-left font-semibold">Renewal $</th>
                  <th class="px-5 py-3 text-right font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                ${m.items.map(renderRow).join('')}
              </tbody>
            </table>
          </div>

          <div class="px-5 py-4 bg-slate-50 border-t border-slate-200 text-sm text-slate-600">
          </div>
        </div>

      </section>

      <!-- Summary -->
      <aside class="lg:col-span-4">
        <div class="sticky top-6 bg-white rounded-2xl p-5 border border-slate-200 shadow-soft">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold">Cart Summary</h3>
              <p class="text-sm text-slate-600 mt-1">${m.items.length} item(s)</p>
            </div>
            <button data-action="copy-quote" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow-soft text-sm font-semibold">
              <i data-lucide="clipboard-copy" class="w-4 h-4"></i> Copy Quote
            </button>
          </div>

          <div class="mt-5 space-y-2 text-sm mono">
            <div class="flex justify-between"><span class="text-slate-600">Total MSRP</span><span class="font-semibold">${money(m.totals.msrp)}</span></div>
            <div class="flex justify-between"><span class="text-slate-600">Partner Net New</span><span class="font-semibold">${money(m.totals.new)}</span></div>
            <div class="flex justify-between"><span class="text-slate-600">Partner Renewal</span><span class="font-semibold">${money(m.totals.ren)}</span></div>
          </div>

          <div class="mt-4 text-sm text-slate-600">
          </div>
        </div>
      </aside>

    </main>

    ${toast()}
  `;

  if (window.lucide?.createIcons) { try { window.lucide.createIcons(); } catch {} }
}

function header(){
  return `
    <header class="sticky top-0 bg-white/90 backdrop-blur border-b border-slate-200 shadow-soft z-20">
      <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between gap-4">
        <div class="min-w-0">
          <h1 class="text-xl font-semibold truncate">Recast Partner Pricing(Estimator)</h1>
        </div>
        <button data-action="copy-quote" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow-soft text-sm font-semibold">
          <i data-lucide="clipboard-copy" class="w-4 h-4"></i> Copy Quote
        </button>
      </div>
    </header>
  `;
}

function tierBtn(label,newM,renM){
  const active = STATE.partnerNewMargin===newM && STATE.partnerRenMargin===renM;
  return `
    <button data-action="set-tier" data-new="${newM}" data-ren="${renM}"
      class="${cx(
        'px-4 py-2 rounded-xl shadow-soft border text-sm font-semibold transition',
        active ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-slate-200 hover:bg-slate-50'
      )}">
      ${label}
      <span class="${cx('ml-2 text-xs', active ? 'text-white/80' : 'text-slate-500')}">(${newM}% / ${renM}%)</span>
    </button>
  `;
}

function renderRow(it){
  // IMPORTANT: options must be join('') to avoid commas/text nodes breaking selection in some browsers.
  const options = Object.entries(PRODUCTS).map(([k,v]) =>
    `<option value="${k}" ${it.productKey===k?'selected':''}>${v.name}</option>`
  ).join('');

  const supportDisabled = it.userMode;
  const supportLabel = supportDisabled ? '—' : (it.addSupport ? 'Premium' : '—');

  return `
    <tr data-item="${it.id}">
      <td class="px-5 py-4">
        <select data-action="change-product"
          class="w-full max-w-[520px] rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600/30">
          ${options}
        </select>
        <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-600">
          <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-1">
            ${it.userMode ? 'Pricing: per user (min 250)' : 'Pricing: per endpoint'}
          </span>
          ${(!it.userMode && it.platformWaived) ? `<span class="inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 px-2 py-1">Platform waived</span>` : ``}
        </div>
      </td>

      <td class="px-5 py-4">
        <div class="flex items-center gap-2">
          <input data-action="edit-qty" value="${it.qty}"
            class="w-28 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-right mono focus:outline-none focus:ring-2 focus:ring-blue-600/30"
            inputmode="numeric" pattern="[0-9]*" />
          <div class="text-xs text-slate-600">${it.qtyLabel}</div>
        </div>
      </td>

      <td class="px-5 py-4">
        <label class="inline-flex items-center gap-2 select-none">
          <input type="checkbox" data-action="toggle-support"
            class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-600"
            ${it.addSupport ? 'checked' : ''}
            ${supportDisabled ? 'disabled' : ''}>
          <span class="${supportDisabled ? 'text-slate-400' : 'text-slate-700'}">${supportLabel}</span>
        </label>
        ${supportDisabled ? `<div class="text-xs text-slate-400 mt-1">Premium support not available in AW per-user model</div>` : ``}
      </td>

      <td class="px-5 py-4 font-semibold mono">${money(it.msrp)}</td>
      <td class="px-5 py-4 mono">${money(it.partnerNew)}</td>
      <td class="px-5 py-4 mono">${money(it.partnerRen)}</td>

      <td class="px-5 py-4 text-right">
        <button data-action="remove-item"
          class="${cx(
            'inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-semibold border shadow-soft',
            STATE.items.length===1 ? 'text-slate-400 border-slate-200 bg-slate-50 cursor-not-allowed' : 'text-red-700 border-red-200 bg-red-50 hover:bg-red-100'
          )}"
          ${STATE.items.length===1 ? 'disabled' : ''}>
          <i data-lucide="trash-2" class="w-4 h-4"></i>
          Remove
        </button>
      </td>
    </tr>
  `;
}

function toast(){
  if(!STATE.toast) return '';
  const ok = STATE.toast.type === 'success';
  return `
    <div class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[60]">
      <div class="${cx(
        'rounded-2xl px-4 py-3 text-sm font-semibold shadow-softer border backdrop-blur',
        ok ? 'bg-emerald-50/90 text-emerald-800 border-emerald-200' : 'bg-red-50/90 text-red-800 border-red-200'
      )}">
        ${STATE.toast.message}
      </div>
    </div>
  `;
}

/* =======================
   EVENTS (delegated)
======================= */
function findRow(el){
  const tr = el.closest('[data-item]');
  if(!tr) return null;
  const id = tr.getAttribute('data-item');
  const item = STATE.items.find(x => x.id === id);
  return { id, item };
}

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('[data-action]');
  if(!btn) return;
  const action = btn.getAttribute('data-action');

  if(action === 'add-item'){
    STATE.items.push({ id: randomId(), productKey: 'rct', qtyText: '1000', addSupport: false, pricingModel: 'endpoint' });
    render();
    setToast('success','Added product.');
    return;
  }

  if(action === 'remove-item'){
    if(STATE.items.length <= 1) return;
    const row = findRow(btn);
    if(!row?.item) return;
    STATE.items = STATE.items.filter(x => x.id !== row.id);
    render();
    setToast('success','Removed item.');
    return;
  }

  if(action === 'set-tier'){
    STATE.partnerNewMargin = +btn.getAttribute('data-new');
    STATE.partnerRenMargin = +btn.getAttribute('data-ren');
    render();
    setToast('success','Partner tier updated.');
    return;
  }

  if(action === 'copy-quote'){
    const m = model();
    const text = buildQuoteText(m);
    const ok = await copyToClipboard(text);
    if(ok) setToast('success','Quote copied to clipboard.');
    else setToast('error','Copy failed (browser blocked clipboard).');
    return;
  }
});

document.addEventListener('change', (e) => {
  const el = e.target;
  const action = el.getAttribute('data-action');
  if(!action) return;

  const row = findRow(el);
  if(!row?.item) return;

  if(action === 'change-product'){
    row.item.productKey = el.value;
    // enforce AW model rules
    if(isAW(row.item.productKey)){
      row.item.pricingModel = 'user';
      row.item.addSupport = false;
      if(int(row.item.qtyText) < 250) row.item.qtyText = '250';
    } else {
      row.item.pricingModel = 'endpoint';
    }
    render();
    return;
  }

  if(action === 'toggle-support'){
    if(isAW(row.item.productKey)){
      row.item.addSupport = false;
    } else {
      row.item.addSupport = !!el.checked;
    }
    render();
    return;
  }
});

document.addEventListener('input', (e) => {
  const el = e.target;
  const action = el.getAttribute('data-action');
  if(action !== 'edit-qty') return;

  const row = findRow(el);
  if(!row?.item) return;

  row.item.qtyText = digitsOnly(el.value);

  // re-render totals while keeping typing stable
  const caret = row.item.qtyText.length;
  render();
  const next = document.querySelector(`[data-item="${row.id}"] [data-action="edit-qty"]`);
  if(next){
    next.focus();
    try { next.setSelectionRange(caret, caret); } catch {}
  }
});

document.addEventListener('blur', (e) => {
  const el = e.target;
  const action = el.getAttribute('data-action');
  if(action !== 'edit-qty') return;

  const row = findRow(el);
  if(!row?.item) return;

  // normalize on blur (incl AW min 250)
  let q = int(row.item.qtyText);
  if(isAW(row.item.productKey)) q = Math.max(250, q);
  row.item.qtyText = String(q);
  render();
}, true);

/* =======================
   INIT
======================= */
document.addEventListener('DOMContentLoaded', () => {
  render();
  if(!window.tailwind){
    const b=document.createElement('div');
    b.role='alert';
    b.className='max-w-7xl mx-auto px-6 mt-3';
    b.innerHTML='<div class="rounded-2xl bg-amber-500/10 border border-amber-400/30 text-amber-900 px-4 py-3 text-sm">Styles failed to load. The estimator still works, but appearance may differ.</div>';
    document.body.prepend(b);
  }
});
</script>
</body>
</html>
